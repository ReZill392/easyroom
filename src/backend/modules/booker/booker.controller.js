const connection = require("../../core/db");
const path = require("path");
const fs = require("fs");

exports.getUserBookings = async (req, res) => {
  const { userId } = req.params;
  console.log("üéØ userId ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤:", userId);

  try {
    await connection.promise().query("SET time_zone = '+07:00'");

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö role ‡∏Ç‡∏≠‡∏á user
    const [userResults] = await connection
      .promise()
      .query("SELECT role FROM user WHERE username = ?", [userId]);

    if (userResults.length === 0) {
      return res.status(404).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });
    }

    const userRole = userResults[0].role;
    console.log(`üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${userId} ‡∏°‡∏µ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô: ${userRole}`);

    let query = "";
    let values = [];

    if (userRole === "‡∏ô‡∏¥‡∏™‡∏¥‡∏ï") {
      query = `
        SELECT 
          rlr.room_request_id, 
          rlr.room_id, 
          rli.room_name,  
          CONVERT_TZ(rlr.submitted_time, '+00:00', '+07:00') AS Submitted_date, 
          CONVERT_TZ(rlr.used_date, '+00:00', '+07:00') AS Used_date, 
          rlr.start_time, 
          rlr.end_time, 
          rlr.request_status, 
          rlr.request_type,
          rlr.reject_reason,
          rlr.detail_reject_reason,
          ad.full_name AS admin_name,
          ex.full_name AS executive_name

        FROM room_request rlr
        JOIN room rli ON rlr.room_id = rli.room_id
        JOIN room_type rt ON rt.room_type_id = rli.room_type_id
        JOIN student s ON rlr.student_id = s.student_id
        LEFT JOIN admin ad ON rlr.admin_id = ad.admin_id
        LEFT JOIN executive ex ON rlr.executive_id = ex.executive_id
        WHERE s.student_id = ?
      `;
      values = [userId];
    } else if (userRole === "‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå") {
      query = `
        SELECT 
          rlr.room_request_id, 
          rlr.room_id, 
          rli.room_name, 
          CONVERT_TZ(rlr.submitted_time, '+00:00', '+07:00') AS Submitted_date, 
          CONVERT_TZ(rlr.used_date, '+00:00', '+07:00') AS Used_date, 
          rlr.start_time, 
          rlr.end_time, 
          rlr.request_status, 
          rlr.request_type,
          rlr.reject_reason,
          rlr.detail_reject_reason,
          ad.full_name AS admin_name,
          ex.full_name AS executive_name

        FROM room_request rlr
        JOIN room rli ON rlr.room_id = rli.room_id
        JOIN room_type rt ON rt.room_type_id = rli.room_type_id
        JOIN teacher t ON rlr.teacher_id = t.teacher_id
        LEFT JOIN admin ad ON rlr.admin_id = ad.admin_id
        LEFT JOIN executive ex ON rlr.executive_id = ex.executive_id
        WHERE t.teacher_id = ?
      `;
      values = [userId];
    } else {
      return res.status(400).json({ error: "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
    }

    const [results] = await connection.promise().query(query, values);
    console.log(`‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á ${userId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:`, results);

    res.json(results);
  } catch (err) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);
    res.status(500).json({ error: "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß" });
  }
};

exports.cancelBooking = async (req, res) => {
  const { requestId } = req.params;
  console.log(`üõë ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ID: ${requestId}`);

  try {
    if (!requestId) {
      console.log("‚ùå requestId ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      return res.status(400).json({ error: "requestId ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ï‡∏≤‡∏° requestId ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const [checkResult] = await connection
      .promise()
      .query("SELECT * FROM room_request WHERE room_request_id = ?", [
        requestId,
      ]);
    console.log("üîç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:", checkResult);

    if (checkResult.length === 0) {
      console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ");
      return res.status(404).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"
    const [updateResult] = await connection.promise().query(
      `
      UPDATE room_request
      SET request_status = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á'
      WHERE room_request_id = ?
    `,
      [requestId]
    );

    console.log("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:", updateResult);

    if (updateResult.affectedRows === 0) {
      console.log("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ");
      return res.status(400).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ" });
    }

    console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ID: ${requestId}`);
    res.json({ success: true, message: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!" });
  } catch (err) {
    console.error("‚ùå ERROR:", err);
    res.status(500).json({ error: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á" });
  }
};

exports.getBrokenEquipments = async (req, res) => {
  console.log("üîç DEBUG: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô", req.session);

  if (!req.session.user || !req.session.user.data) {
    return res.status(401).json({ error: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" });
  }

  const { role, data } = req.session.user;
  let userId = null;
  let query = "";
  let values = [];

  if (role === "‡∏ô‡∏¥‡∏™‡∏¥‡∏ï") {
    userId = data.student_id;
    console.log("üéØ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏¥‡∏™‡∏¥‡∏ï student_id:", userId);

    query = `
          SELECT 
              DATE_FORMAT(eb.repair_date, '%Y-%m-%d %H:%i:%s') AS repair_date, 
              ei.equipment_name, 
              eb.damage_details, 
              eb.room_id, 
              CASE 
                  WHEN eb.admin_id IS NULL THEN '‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' 
                  ELSE ai.full_name 
              END AS Admin_Name, 
              eb.repair_status,
              eb.image_path,
              eb.repair_number,
              damage
          FROM equipment_brokened eb
          LEFT JOIN equipment ei ON eb.equipment_id = ei.equipment_id
          LEFT JOIN admin ai ON eb.admin_id = ai.admin_id
          WHERE eb.student_id = ?
          ORDER BY eb.repair_date DESC;
      `;
    values = [userId];
  } else if (role === "‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå") {
    userId = data.teacher_id;
    console.log("üéØ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå teacher_id:", userId);

    query = `
          SELECT 
              DATE_FORMAT(eb.repair_date, '%Y-%m-%d %H:%i:%s') AS repair_date, 
              ei.equipment_name, 
              eb.damage_details, 
              eb.room_id, 
              CASE 
                  WHEN eb.admin_id IS NULL THEN '‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' 
                  ELSE ai.full_name 
              END AS Admin_Name, 
              eb.repair_status,
              eb.image_path,
              eb.repair_number,
              damage
          FROM equipment_brokened eb
          LEFT JOIN equipment ei ON eb.equipment_id = ei.equipment_id
          LEFT JOIN admin ai ON eb.admin_id = ai.admin_id
          WHERE eb.teacher_id = ?
          ORDER BY eb.repair_date DESC;
      `;
    values = [userId];
  } else {
    return res.status(400).json({ error: "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
  }

  try {
    console.log("üöÄ ‡∏£‡∏±‡∏ô SQL Query:", query);
    console.log("üìå ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Query:", values);

    const [results] = await connection.promise().query(query, values);
    console.log("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", results);

    res.json(results);
  } catch (err) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", err);
    res.status(500).json({ error: "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß" });
  }
};

exports.getBrokenEquipmentsImage = async (req, res) => {
  const filename = req.params.filename;
  const filePath = path.join(
    __dirname,
    "../../storage/equipment_img",
    filename
  );

  if (fs.existsSync(filePath)) {
    res.setHeader("Content-Type", "image/jpeg");
    res.sendFile(filePath);
  } else {
    res.status(404).json({ error: "File not found" });
  }
};

exports.getComputerManagement = async (req, res) => {
  connection.query("SELECT * FROM computer_management", (err, results) => {
    if (err) {
      console.error("‚ùå Error:", err);
      res.status(500).send(err);
      return;
    }
    console.log("‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", results.length);
    res.json(results);
  });
};

exports.getRoomDetail = async (req, res) => {
  const query = `
    SELECT
      rli.room_name AS full_name,
      rli.floor,
      rli.room_id,
      rli.room_name,
      rt.type_name AS room_type, --
      SUM(CASE WHEN rlr.request_status = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' THEN 1 ELSE 0 END) AS Approved_Count
    FROM room rli
    LEFT JOIN room_request rlr ON rli.room_id = rlr.room_id
    LEFT JOIN room_type rt ON rli.room_type_id = rt.room_type_id -- 
    GROUP BY rli.room_id, rli.room_name, rli.floor, rli.room_name
    ORDER BY Approved_Count DESC;
  `;

  connection.query(query, (err, results) => {
    if (err) {
      console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);

      res.status(500).send(err);

      return;
    }

    console.log("‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", results);

    res.json(results);
  });
};

exports.getRooms = async (req, res) => {
  try {
    const [results] = await connection
      .promise()
      .query("SELECT room_id, room_name, room_status FROM room");
    res.json(results);
  } catch (err) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á:", err);
    res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ" });
  }
};
